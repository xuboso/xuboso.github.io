---
title: Linux IO多路复用
date: 2025-02-25 16:08:38
tags:
  - linux
---

Linux 网络中的 I/O 多路复用机制是一种高效处理多个 I/O 事件的模型，它允许单个线程或进程同时监视多个文件描述符（如套接字），并在其中任何一个文件描述符就绪时进行处理。其核心原理如下：

1. **基本思想**:

   - I/O 多路复用通过一个系统调用（如 `select`、`poll`、`epoll`）同时监视多个文件描述符，避免了为每个文件描述符创建单独的线程或进程的开销。
   - 当某个文件描述符就绪（如数据可读、可写或异常）时，多路复用机制会通知应用程序进行处理。

2. **核心机制**:

   - **文件描述符集合**: 多路复用机制维护一个文件描述符集合，应用程序通过系统调用告诉内核需要监视哪些文件描述符。
   - **事件等待**: 内核会挂起调用线程，直到至少有一个文件描述符就绪，或者超时。
   - **事件通知**: 当有文件描述符就绪时，内核会唤醒调用线程，并返回就绪的文件描述符集合。

3. **常用实现**:

   - **`select`**:
     - 使用位掩码表示文件描述符集合，可以监视的文件描述符数量有限（通常为 1024）。
     - 每次调用需要将整个文件描述符集合从用户空间复制到内核空间，效率较低。
     - 返回时，整个集合被修改，应用程序需要遍历所有文件描述符以确定哪些就绪。
   - **`poll`**:
     - 使用 `pollfd` 结构体表示文件描述符集合，可以监视的文件描述符数量没有限制。
     - 解决了 `select` 的文件描述符数量限制问题，但仍需要将整个集合从用户空间复制到内核空间。
     - 返回时，需要对整个集合进行遍历以确定哪些文件描述符就绪。
   - **`epoll`**:
     - 基于事件驱动的模型，是目前 Linux 上最常用的 I/O 多路复用机制。
     - 使用 `epoll_create` 创建一个 `epoll` 实例，然后通过 `epoll_ctl` 向其中添加或删除文件描述符。
     - 通过 `epoll_wait` 等待事件，内核只返回就绪的文件描述符，大大减少了遍历的开销。
     - 支持边缘触发（ET）和水平触发（LT）模式，边缘触发模式可以减少事件通知的次数，进一步提高效率。

4. **性能对比**:

   - `select` 和 `poll` 在文件描述符数量较多时性能较差，因为每次调用都需要遍历整个集合。
   - `epoll` 在文件描述符数量较多时性能更优，因为它只返回就绪的文件描述符，且不需要每次都复制整个集合。

5. **适用场景**:
   - I/O 多路复用适用于需要同时处理多个 I/O 事件的场景，如网络服务器、实时通信系统等。
   - 特别是 `epoll`，在大规模并发连接的情况下，性能优势尤为明显。

总结来说，I/O 多路复用机制通过高效地监视和处理多个文件描述符，极大地提升了 I/O 密集型应用程序的性能和可扩展性
